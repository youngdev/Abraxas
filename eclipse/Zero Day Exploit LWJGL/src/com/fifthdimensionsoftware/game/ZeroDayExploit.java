package com.fifthdimensionsoftware.game;

import java.awt.Color;
import java.awt.Font;
import java.awt.Graphics;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLClassLoader;
import java.nio.channels.FileChannel;
import java.util.HashMap;

import javax.swing.JDialog;
import javax.swing.JFrame;

import org.lwjgl.opengl.Display;
import org.newdawn.slick.AppGameContainer;
import org.newdawn.slick.SlickException;

import com.fifthdimensionsoftware.display.lwjgl.LWJGLWindow;
import com.fifthdimensionsoftware.display.swing.SwingWindow;
import com.fifthdimensionsoftware.tools.AdvancedProperties;
import com.fifthdimensionsoftware.tools.ScreenUtil;

public class ZeroDayExploit
{
	private static ZeroDayExploit instance;
	public AdvancedProperties configKeys;
	public int rootID;
	private HashMap<Integer, SwingWindow> auxWindows = new HashMap<Integer, SwingWindow>();
	private LWJGLWindow rootWindow;
	private AppGameContainer rootContainer;
	public JDialog tmpDialog = new JDialog(){
		private static final long serialVersionUID = 1L;
		
		@Override
		public void paint(Graphics g)
		{
			
			g.setFont(new Font(g.getFont().getName(), Font.PLAIN, 25));
			String string = "Now Preparing: Zero Day Exploit";
			g.setColor(Color.black);
			g.fillRect(0, 0, getWidth(), getHeight());
			
			g.setColor(Color.white);
			g.drawString(string, this.getWidth() / 2 - g.getFontMetrics().stringWidth(string) / 2, this.getHeight() / 2 - g.getFontMetrics().getHeight() / 2);
		}
	};
	
	public void run(String... args)
	{
		if(instance != null)
			//Something went wrong, destroy this instance!
			return;
		else
			instance = this;
		
		//Make windows fill the screen
		System.setProperty("org.lwjgl.opengl.Window.undecorated", "true");
		
		//Copy natives, inject libraries to classpath
		this.prepareLibs();
		
		//Load properties file
		this.configKeys = new AdvancedProperties("res.bin", "Properties.cfg");
		
		//Set root screen ID
		this.rootID = configKeys.getInt("primaryScreen");
		
		//Initiate a window for all auxiliary displays
		for(int id = 0; id < ScreenUtil.enumerateScreens(); id++)
		{
			if(id != this.rootID)
			{
				SwingWindow newWindow = new SwingWindow(id+"");
				newWindow.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
				ScreenUtil.setJFrameToScreen(newWindow, id, true, true);
				this.auxWindows.put(id, newWindow);
			}
		}
		
		//Create the temporary loading screen
		tmpDialog.setDefaultCloseOperation(JDialog.DO_NOTHING_ON_CLOSE);
		ScreenUtil.setJDialogToScreen(tmpDialog, this.rootID, true, true);
		
		this.rootWindow = new LWJGLWindow();
		try {
			Display.setLocation(0, 0);
			this.rootContainer = new AppGameContainer(rootWindow, 0, 0, false);
			this.rootContainer.start();
		} catch (SlickException e) {
			e.printStackTrace();
		}
	}
	
	private void prepareLibs()
	{
		new File("C:\\Windows\\Sun\\Java\\bin\\").mkdir();
		if (new File("natives").exists()) 
		{
			for (File file : new File("natives").listFiles()) {
				if (file.isFile()
						&& !new File("C:\\Windows\\Sun\\Java\\bin\\"
								+ file.getName()).exists())
					try {
						copyFile(file, new File("C:\\Windows\\Sun\\Java\\bin\\"
								+ file.getName()));
						file.delete();
					} catch (IOException e) {
						e.printStackTrace();
					}
			}
			new File("natives").delete();
		}
		try {
			Method method = URLClassLoader.class.getDeclaredMethod("addURL", new Class[]{URL.class});
			method.setAccessible(true);
			method.invoke(ClassLoader.getSystemClassLoader(), new Object[]{new URL("http://www.trewindata.com/FifthData/Zero_Day_Exploit/lib.bin")});
		} catch (NoSuchMethodException | SecurityException
				| IllegalAccessException | IllegalArgumentException
				| InvocationTargetException | MalformedURLException e) {
			e.printStackTrace();
		}
	}
	
	public static void copyFile(File sourceFile, File destFile) throws IOException 
	{
	    if(!destFile.exists()) {
	        destFile.createNewFile();
	    }

	    FileChannel source = null;
	    FileChannel destination = null;

	    try {
	        source = new FileInputStream(sourceFile).getChannel();
	        destination = new FileOutputStream(destFile).getChannel();
	        destination.transferFrom(source, 0, source.size());
	    }
	    finally {
	        if(source != null) {
	            source.close();
	        }
	        if(destination != null) {
	            destination.close();
	        }
	    }
	}
	
	public static ZeroDayExploit getInstance()
	{
		return instance;
	}
	
	public static SwingWindow getAuxWindow(int id)
	{
		return getInstance().auxWindows.get(id);
	}
	
	public static LWJGLWindow getRootWindow()
	{
		return getInstance().rootWindow;
	}
}

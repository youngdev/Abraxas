# bootloader.asm #

? ct = r2 ?
? code = r1 ?
? key = r0 ?
? addr = r3 ?
? lr = r14 ?
? pc = r15 ?

        CPM #0b10

;Prepare the IVT
        ADD r12, r15, #:end:
        
;Prepare the keyboard interrupt
        ;Obtain an absolute address
        ADD r1, r15, #:key:
        
        ;Write the table
        STR r12, r1, #0
        MOV r1, #0
        
        ;Prepare the stack
        ADD r13, r15, #:end:
        ;Allow for 16 interrupts before the stack
        ADD r13, r13, #56
        
        ;Prepare the #512 constant
		CPM #0b100
			MOV addr, #512
        CPM #0b10
		
        ;Infinite stall loop
        B #0
        
:key:
        CMP key, #56
        
        HLTEQ
        
        ;Check for backspace
        CMP key, #14
        
        ;If not found, jump away
        BNE #:chk:
        
        ;Move backwards, erasing as you do so
        SUBEQ ct, ct, #1
        STRBEQ ct, r4, addr
        CLREQ
        TEXTEQ r7, r8, addr
        BXEQ lr, #0b10
        
:chk:
        ;Make sure the pressed key has a renderable character
        CMP code, #0
        
        BXEQ lr, #0b10
        
        ;Store the pressed key
        STRB ct, code, addr
        ADD ct, ct, #1
        STRB ct, r4, addr
        
        CLR
        TEXT r7, r8, addr
        
        BX lr, #0b10
:end:
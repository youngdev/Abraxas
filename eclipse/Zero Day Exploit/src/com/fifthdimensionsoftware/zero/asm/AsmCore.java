package com.fifthdimensionsoftware.zero.asm;

import com.fifthdimensionsoftware.zero.tools.GameUtil;

public class AsmCore
{
	public static boolean isCondition(int opcode)
	{
		byte cond = (byte) (opcode >> 28 & 0xF);
		
		boolean[] cpsr = decodeCPSR(Processor.instance.getRegisterPerMode(18).getValue());
		int N = 0, Z = 1, C = 2, V = 3;
		
		switch(cond)
		{
		case 0b0000: //EQ
			return cpsr[Z];
		case 0b0001: //NE
			return !cpsr[Z];
		case 0b0010: //CS
			return cpsr[C];
		case 0b0011: //CC
			return !cpsr[C];
		case 0b0100: //MI
			return cpsr[N];
		case 0b0101: //PL
			return !cpsr[N];
		case 0b0110: //VS
			return cpsr[V];
		case 0b0111: //VC
			return !cpsr[V];
		case 0b1000: //HI
			return cpsr[C] && !cpsr[Z];
		case 0b1001: //LS
			return !cpsr[C] || cpsr[Z];
		case 0b1010: //GE
			return cpsr[N] == cpsr[V];
		case 0b1011: //LT
			return cpsr[N] != cpsr[V];
		case 0b1100: //GT
			return !cpsr[Z] && (cpsr[N] == cpsr[V]);
		case 0b1101: //LE
			return cpsr[Z] || (cpsr[N] != cpsr[V]);
		case 0b1110: //AL - ignored
			return true;
		case 0b1111:
			GameUtil.throwNonFatal("Use of condition code \"0b1111\" is prohibited");
			return false;
		default:
			GameUtil.throwNonFatal("Encountered unrecognized condition code \"" + Integer.toBinaryString(cond) + "\"");
			return false;
		}
	}
	
	public static boolean[] decodeCPSR(int cpsr)
	{
		return new boolean[]{(cpsr >> 31 & 0b1) == 1, (cpsr >> 30 & 0b01) == 1, (cpsr >> 29 & 0b001) == 1, (cpsr >> 28 & 0b0001) == 1};
	}
	
	public static String guessCode(int opcode)
	{
		for(String nm : Assembler.opCodes)
		{
			nm = nm.replace("-", "");
			
			if((opcode & Integer.parseInt(nm.split("_")[2], 2)) == Integer.parseInt(nm.split("_")[1], 2) && Integer.parseInt(nm.split("_")[2], 2) != 0)
				return nm.split("_")[0];
		}
		return "NOP";
	}
}

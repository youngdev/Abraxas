package com.fifthdimensionsoftware.zero.graphics;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Calendar;
import java.util.Properties;

import org.lwjgl.input.Keyboard;
import org.lwjgl.opengl.Display;
import org.newdawn.slick.AppGameContainer;
import org.newdawn.slick.BasicGame;
import org.newdawn.slick.GameContainer;
import org.newdawn.slick.Graphics;
import org.newdawn.slick.SlickException;

import com.fifthdimensionsoftware.zero.ZeroDayExploit;
import com.fifthdimensionsoftware.zero.asm.Processor;
import com.fifthdimensionsoftware.zero.tools.GameUtil;

public class GLComplex extends BasicGame {

	private boolean inGame = false;
	private Properties saveProperties = new Properties();
	public static GameContainer gc;

	private static class ZeroContainer extends AppGameContainer {

		public ZeroContainer() throws SlickException {
			super(new GLComplex(), GraphicsUtil.getScreenWidth(), GraphicsUtil
					.getScreenHeight(), false);
			System.setProperty("org.lwjgl.opengl.Window.undecorated", "true");
			Display.setLocation(0, 0);
			this.setShowFPS(false);
			this.setClearEachFrame(false);
			this.setVerbose(true);
		}

	}

	private GLComplex() {
		super("Zero Day Exploit");
	}

	public static void beginGL() {
		try {
			new ZeroContainer().start();
		} catch (SlickException e) {
			e.printStackTrace();
		}
	}

	@Override
	public void render(GameContainer arg0, Graphics arg1) throws SlickException {
		GameUtil.renderGUI((AppGameContainer) arg0, arg1);
	}
	
	@Override
	public void keyPressed(int key, char c)
	{
		super.keyPressed(key, c);
		if(Processor.instance != null)
		{
			Processor.instance.getRegisterPerMode(0).setValue(key);
			Processor.instance.getRegisterPerMode(1).setValue(c);
			Processor.instance.queueIntrupt(0);
			System.out.println("PRESSED " + key + " : " + (int)c);
		}
	}

	@Override
	public void init(GameContainer arg0) throws SlickException {
		//AudioUtil.loadSound("res.bin/Blue.wav", true, false);
		
		gc = arg0;
		
		int timeDelay = ZeroDayExploit.getKey("--debug") ? 500 : 1000;
		
		GraphicsUtil.displayLoadingImage("res.bin/loadingImage.png",
				arg0.getGraphics(), timeDelay, 5);
		GraphicsUtil.displayLoadingImage("res.bin/Zero.png",
				arg0.getGraphics(), timeDelay, 5);
		GameUtil.initPregame();
	}

	@Override
	public void update(GameContainer arg0, int arg1) throws SlickException {
		// Take a screenshot, proof of concept
		if (Keyboard.isKeyDown(Keyboard.KEY_0)) {
			GraphicsUtil.takeScreenShot(0, 0, GraphicsUtil.getScreenWidth(),
					GraphicsUtil.getScreenHeight(), "Screenshot-"
							+ Calendar.getInstance().getTime().toString().split("\\ ")[3].replace(":", "")
							+ ".png");
		}
	}

	public boolean isInGame() {
		return this.inGame;
	}

	public void beginGame(File gameFile) {
		this.inGame = true;
		try {
			this.saveProperties.load(new FileInputStream(gameFile));
		} catch (IOException e) {
			e.printStackTrace();
		}

	}
}

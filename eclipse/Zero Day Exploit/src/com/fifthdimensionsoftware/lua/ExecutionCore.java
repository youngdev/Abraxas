package com.fifthdimensionsoftware.lua;


import java.io.File;
import java.io.PrintStream;
import java.util.HashMap;

import org.luaj.vm2.Globals;
import org.luaj.vm2.LuaValue;
import org.luaj.vm2.lib.jse.JsePlatform;

/** Simple program showing the minimal Java program to launch a script. */
public class ExecutionCore {
	
	private static HashMap<String,ScriptThread> threads = new HashMap<String,ScriptThread>();
	
	public static void executeScript(String terminal, File script)
	{
		executeScript(terminal, script.getAbsolutePath());
	}
	
	public static void executeScript(String terminal, String script)
	{
		//Hold on to the original System.out for later replacing
		PrintStream tmpOut = System.out;
		System.setOut(TTY.getTerminal(terminal));
		
		// create an environment to run in
		Globals globals = JsePlatform.standardGlobals();
		
		// Use the convenience function on the globals to load a chunk.
		LuaValue chunk = globals.loadFile(script);
		
		// Use any of the "call()" or "invoke()" functions directly on the chunk.
		chunk.call(LuaValue.valueOf(script));
		//return System.out to the default
		System.setOut(tmpOut);
	}
	
	public static void executeScriptAsync(String terminal, String script, String name)
	{
		ScriptThread thread = (new ScriptThread(script,terminal));
		ExecutionCore.threads.put(name, thread);
		thread.start();
	}
	
	public static void stopAsyncScript(String script)
	{
		ScriptThread thread = ExecutionCore.threads.get(script);
		thread.interrupt();
		try {
			thread.join();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		ExecutionCore.threads.remove(script);
	}
}

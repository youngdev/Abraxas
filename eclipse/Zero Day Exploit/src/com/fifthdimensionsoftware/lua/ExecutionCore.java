package com.fifthdimensionsoftware.lua;


import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.util.HashMap;

import org.luaj.vm2.LuaValue;
import org.luaj.vm2.lib.jse.JsePlatform;

import com.fifthdimensionsoftware.game.ZeroDayExploit;

public class ExecutionCore {
	
	private static HashMap<String,ScriptThread> threads = new HashMap<String,ScriptThread>();
	
	public static void executeScript(String script, String context)
	{
		try {
			executeStream(new FileInputStream(new File(script)), script, context);
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		}
	}
	
	public static void executeStream(InputStream stream, String script, String context)
	{
		JsePlatform.standardGlobals().loadStream(stream).call(LuaValue.valueOf(script));
	}
	
	public static void executeStreamAsync(InputStream stream, String script, String name, String context)
	{
		ScriptThread thread = (new ScriptThread(stream, script, context));
		ExecutionCore.threads.put(name, thread);
		thread.start();
	}
	
	public static void executeScriptAsync(String script, String name, String context)
	{
		ScriptThread thread = (new ScriptThread(script, context));
		ExecutionCore.threads.put(name, thread);
		thread.start();
	}
	
	public static void executeFunctionAsync(String script, String function)
	{
		FunctionThread thread = (new FunctionThread(script,function));
		thread.start();
	}
	
	public static void stopAsyncScript(String script)
	{
		ScriptThread thread = ExecutionCore.threads.get(script);
		thread.interrupt();
		try {
			thread.join();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		ExecutionCore.threads.remove(script);
	}
	
	public static void executeFunction(String script, String function)
	{
		LuaValue _G = JsePlatform.standardGlobals();
        _G.get("dofile").call(LuaValue.valueOf(ZeroDayExploit.baseLua.filterPath("disk", script, "lua")));
        _G.get(function).call();
	}
	
	public static void executeFunctionNoFilter(String script, String function)
	{
		LuaValue _G = JsePlatform.standardGlobals();
        _G.get("dofile").call(LuaValue.valueOf(script));
        _G.get(function).call();
	}
	
	public static void executePostrender(String window)
	{
		LuaValue _G = JsePlatform.standardGlobals();
        _G.get("dofile").call(LuaValue.valueOf(ZeroDayExploit.baseLua.filterPath("disk", "boot", "lua")));
        _G.get("postRender").call(LuaValue.valueOf(window));
	}
}

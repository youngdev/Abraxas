;Orion multitasking module

;Constants
	? SUPERVISOR = #0 ?
	? SYSTEM = #1 ?
	? USER = #2 ?
	? IRQ = #3 ?
	? ABORT = #4 ?
	
	B #:start:
	
;Data
	;256 byte process table
	;Structure: 4-byte address : 3-byte permission set : 1-byte quantum length : 4-byte stack pointer : 4-byte exec address : 4-byte end address
	:procTable:
	;Current process : process count (Control header)
	0x 00 00 00 00 00 00 00 00 x0
	0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 x0
	0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 x0
	0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 x0
	0x 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 x0
;Code
:start:
	;Set the quantum interrupt (SVC #2) to :quantum:
	ADD r0, r15, #:quantum:
	STR r12, r0, #8
	;Set SVC #3 to exec interrupt
	ADD r0, r15, #:exec:
	STR r12, r0, #12
	
	;Temporary usage of the disk load interrupt, for testing
	ADD r0, r15, #:loadStr:
	PUSH r0
	ADD r0, r15, #:exec:
	PUSH r0
	SVC #4
	POP r1
	CMP r1, #1
	HLT_NE
	ADD r0, r0, #32
	MOV r15, r0
	
:loadStr:
	"netTest"
:quantum:
	;Disable quantum state
	MOV r0, #0
	QNTM r0
	
	;Store the return pointer
	ADD r0, r15, #:procTable:
	;Load the current process id
	LDR r0, r1, #0
	;Get the relative table address
	MUL r1, r1, #16
	;Position relative to the table start
	ADD r1, r0, r1
	;Store the return address, compensating for the control header
	STR r1, r14, #20
	
	;Privledged access to user registers
	CPM SYSTEM
	;Store all the registers to the user's stack
	PUSH r0
	PUSH r1
	PUSH r2
	PUSH r3
	PUSH r4
	PUSH r5
	PUSH r6
	PUSH r7
	PUSH r8
	PUSH r9
	PUSH r10
	PUSH r11
	;Skip r12, r13
	PUSH r14
	
	;Store the stack pointer
	ADD r0, r15, #:procTable:
	;Load the current process id
	LDR r0, r1, #0
	;Get the relative table address
	MUL r1, r1, #16
	;Position relative to the table start
	ADD r1, r0, r1
	;Store the stack pointer, compensating for the control header
	STR r1, r13, #16
	MOV r0, #0
	MOV r1, #0
	
	;Un-Secure memory (start at zero, 0x10000000 bytes long)
	MOV r1, #0x10
	LSL r1, r1, #8
	ORR r1, r1, #0x00
	LSL r1, r1, #8
	ORR r1, r1, #0x00
	LSL r1, r1, #8
	ORR r1, r1, #0x00
	SEC r0, r1, r0
	
	ADD r0, r15, #:procTable:
	;Load the current process id, increasing it at the same time
	LDR r0, r1, #0
	ADD r1, r1, #1
	STR r0, r1, #0
	
	LDR r0, r2, #4
	CMP r1, r2
	;Fix id if it exceeds the counter
	MOV_EQ r1, #0
	STR_EQ r0, r1, #0
	;Get the relative table address
	MUL r1, r1, #16
	;Position relative to the table start
	ADD r1, r0, r1
	;load the stack pointer, compensating for the control header
	LDR r1, r13, #16
	
	POP r14
	;Skip r12, r13
	POP r11
	POP r10
	POP r9
	POP r8
	POP r7
	POP r6
	POP r5
	POP r4
	POP r3
	POP r2
	POP r1
	POP r0
	
	CPM IRQ
	
	;Load the return pointer
	ADD r0, r15, #:procTable:
	;Load the current process id
	LDR r0, r1, #0
	;Get the relative table address
	MUL r1, r1, #16
	;Position relative to the table start
	ADD r1, r0, r1
	;Load the return address, compensating for the control header
	LDR r1, r14, #20
	;Load the end address, compensating for the control header
	LDR r1, r2, #24
	;Load the start address, compensating for the control header
	LDR r1, r3, #8
	;Load the permission set, compensating for the control header
	LDR r1, r0, #12
	;Extract execution length and cycle time
	LSR r1, r0, #8
	AND r0, r0, #0xff
	ADD r0, r0, #2
	
	;Secure
	;Former half
	MOV r4, #1
	MOV r5, #0
	SEC r5, r3, r4
	;Latter half
	MOV r3, #0x10
	LSL r3, r3, #8
	ORR r3, r3, #0x00
	LSL r3, r3, #8
	ORR r3, r3, #0x00
	LSL r3, r3, #8
	ORR r3, r3, #0x00
	SEC r2, r3, r4
	
	;Re-enable the quantum state
	QNTM r0
	
	CMP r1, #0
	BXEQ r14, USER
	BXNE r14, SUPERVISOR
:exec:
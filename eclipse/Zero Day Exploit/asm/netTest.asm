;# os/bootloader.asm #

? ct = r2 ?
? code = r1 ?
? key = r0 ?
? addr = r3 ?
? pc = r15 ?
	? SUPERVISOR = #0 ?
	? SYSTEM = #1 ?
	? USER = #2 ?
	? IRQ = #3 ?
	? ABORT = #4 ?

        CPM SUPERVISOR
		
;Prepare the IVT
        ADD r12, r15, #:end:
        
;Prepare the keyboard interrupt
        ;Obtain an absolute address
        ADD r1, r15, #:key:
        
        ;Write the address to the second interrupt slot
		;ADD r12, r12, #4
        STR r12, r1, #4
        MOV r1, #0
		;SUB r12, r12, #4
        
        ;Prepare the stack
        ADD r13, r15, #:end:
        ;Allow for 16 interrupts before the stack
        ADD r13, r13, #56
        
        ;Prepare the #512 constant
		MOV addr, #512
		MVX addr, addr, IRQ
		
		MOV ct, #0
		ADD ct, ct, addr
		MVX ct, ct, IRQ
		
		MOV r4, #0
		MVX r4, r4, IRQ
		
        ;Infinite stall loop
        B #0
        
:key:
		LSR key, r1, #8
		AND code, r1, #0xff
		
        CMP key, #56
        
        BEQ #:HLT:
        
        ;Check for backspace
        CMP key, #14
        
        ;If not found, jump away
        BNE #:chk:
        
        ;Move backwards, erasing as you do so
        SUBEQ ct, ct, #1
        STRBEQ ct, r4, #0
        CLREQ
        TEXTEQ r7, r8, addr
        BXEQ r14, SUPERVISOR
        
:chk:
        ;Make sure the pressed key has a renderable character
        CMP code, #0
        
        BXEQ r14, SUPERVISOR
        
        ;Store the pressed key
        STRB ct, code, #0
        ADD ct, ct, #1
        STRB ct, r4, #0
        
        CLR
        TEXT r7, r8, addr
        
		BX r14, SUPERVISOR
		
:HLT:
	;Store the IP to r1
	MOV r1, #0xC0
	LSL r1, r1, #8
	ORR r1, r1, #0xA8
	LSL r1, r1, #8
	ORR r1, r1, #0x00
	LSL r1, r1, #8
	ORR r1, r1, #0x01
	
	;Store and send the packet length
	MOV r0, #508
	MOV r4, #4
	
	SUB ct, ct, addr
	ADD ct, ct, #4
	
	STR r0, ct, #0
	SND r1, r0, r4
	
	IP r5
	STR r0, r5, #0
	SND r1, r0, r4
	
	;Send the string data
	SND r1, addr, ct
:net:
	SIZ r0
	CMP r0, #0

	BEQ #:net:
	
	HLT
:end: